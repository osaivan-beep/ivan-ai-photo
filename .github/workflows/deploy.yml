
name: Deploy to Firebase Hosting and Functions

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Frontend Dependencies
        run: npm install

      - name: Install Backend Functions Dependencies
        run: cd functions && npm install

      - name: Build Frontend
        run: npm run build

      - name: Create Service Account File (Node.js Method)
        env:
          SA_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          node -e "
            const fs = require('fs');
            const key = process.env.SA_KEY;
            if (!key) {
              console.error('❌ Error: FIREBASE_SERVICE_ACCOUNT secret is missing!');
              process.exit(1);
            }
            try {
              // Try to parse to ensure it's valid JSON
              JSON.parse(key);
              // Write raw key to file
              fs.writeFileSync('service-account.json', key);
              console.log('✅ Service Account file created (service-account.json)');
            } catch (e) {
              console.error('❌ Error: The Secret is not valid JSON.');
              console.error(e.message);
              process.exit(1);
            }
          "

      - name: Install Firebase Tools
        run: npm install -g firebase-tools

      - name: Deploy to Firebase (SAFE MODE - GEN 1 asia-east1)
        # 修正處：加入 firestore 確保規則被部署
        run: firebase deploy --project ivan-ai-photo-web --only hosting,functions:ivanGeniusTw,firestore --force
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ./service-account.json
